# Cloud SQL - Data Fusion - BigQuery

Cloud SQLê³¼ BigQuery ë°ì´í„°ë¥¼ ë™ê¸°í™”í•˜ê¸° ìœ„í•´ Data Fusionì„ ì‚¬ìš©í•˜ì—¬ íŒŒì´í”„ë¼ì¸ì„ [A Deep dive into Cloud Data Fusion "Replication" Feature | CDC pipeline from MS SQL Server to](https://blog.searce.com/a-deep-dive-into-cloud-data-fusion-replication-feature-cdc-pipeline-from-ms-sql-server-to-5534ef58f074)
ì™€ ê°™ì´ ì„¤ê³„í•˜ì˜€ë‹¤.

Cloud SQLì—ì„œ MySQLì˜ ê²½ìš° binary logë¥¼ í™œì„±í™”í•˜ì—¬ Data Fusionì—ì„œ CDCë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸ê°€ ì§„í–‰ë  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

## MySQL - BigQuery Replicate

[Database replication to BigQuery using change data capture | Cloud Architecture Center | Google Cloud](https://cloud.google.com/architecture/database-replication-to-bigquery-using-change-data-capture)

![Untitled](Untitled.png)

ì´ˆê¸° ë°ì´í„°ëŠ” BigQueryì— ë¤í”„í•´ë†“ê³  ì´í›„ì— ë³€ê²½ ì‚¬í•­ì€ CDCì—ì„œ ì²˜ë¦¬í•œë‹¤. ë³€ê²½ëœ ë°ì´í„°ë¥¼ Delta tableì— ì˜¬ë¦¬ê³  ê¸°ì¡´ì˜ Main Tableê³¼ MERGE í•œë‹¤.

ë‹¤ìŒê³¼ ê°™ì€ ì¡°ì¸ ë°©ì‹ì´ ìˆë‹¤.

- **ì¦‰ê°ì  ì¼ê´€ì„± ë°©ì‹**: ì¿¼ë¦¬ëŠ” ë³µì œëœ ë°ì´í„°ì˜ í˜„ì¬ ìƒíƒœë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤. ì¦‰ê°ì  ì¼ê´€ì„±ì—ëŠ” ê¸°ë³¸ í…Œì´ë¸”ê³¼ ë¸íƒ€ í…Œì´ë¸”ì„ ì¡°ì¸í•˜ëŠ” ì¿¼ë¦¬ê°€ í•„ìš”í•˜ë©° ê° ê¸°ë³¸ í‚¤ì— ëŒ€í•œ ìµœì‹  í–‰ì„ ì„ íƒí•©ë‹ˆë‹¤.
    
    ```bash
    bq mk --view \
    "SELECT * EXCEPT(change_type, row_num)
    FROM (
      SELECT *, ROW_NUMBER() OVER (PARTITION BY id ORDER BY change_id DESC) AS row_num
      FROM (
        SELECT * EXCEPT(change_type), change_type
        FROM \`**$(gcloud config get-value project).cdc_tutorial.session_delta**\` UNION ALL
        SELECT *, 'I'
        FROM \`**$(gcloud config get-value project).cdc_tutorial.session_main\**`))
    WHERE
      row_num = 1
      AND change_type <> 'D'" **cdc_tutorial.session_latest_v**
    ```
    
- **ë¹„ìš© ìµœì í™” ë°©ì‹**: ë°ì´í„° ê°€ìš©ì„±ì´ ì•½ê°„ ì§€ì—°ë˜ëŠ” ëŒ€ì‹  ë” ë¹ ë¥´ê³  ì €ë ´í•œ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤. ì£¼ê¸°ì ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê¸°ë³¸ í…Œì´ë¸”ì— ë³‘í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    ```bash
    bq query \
    'MERGE `cdc_tutorial.session_main` m
    USING
      (
      SELECT * EXCEPT(row_num)
      FROM (
        SELECT *, ROW_NUMBER() OVER(PARTITION BY delta.id ORDER BY delta.change_id DESC) AS row_num
        FROM `**cdc_tutorial.session_delta**` delta )
      WHERE row_num = 1) d
    ON  m.id = d.id
      WHEN NOT MATCHED
    AND change_type IN ("I", "U") THEN
    INSERT (id, username, change_id)
    VALUES (d.id, d.username, d.change_id)
      WHEN MATCHED
      AND d.change_type = "D" THEN
    DELETE
      WHEN MATCHED
      AND d.change_type = "U"
      AND (m.change_id < d.change_id) THEN
    UPDATE
    SET username = d.username, change_id = d.change_id'
    ```
    
- **í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹**: ìš”êµ¬ì‚¬í•­ ë° ì˜ˆì‚°ì— ë”°ë¼ ì¦‰ê°ì  ì¼ê´€ì„± ë°©ì‹ ë˜ëŠ” ë¹„ìš© ìµœì í™” ë°©ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

## Data Fusion
data fusion replicationìœ¼ë¡œ BigQueryë¡œ ë°ì´í„°ë¥¼ ë³µì‚¬í•  ìˆ˜ ìˆëŠ”ë° postgresql ì€ ì—†ë‹¤. 

![Untitled](Untitled%201.png)

MySQLë¡œ ì—°ë™í•˜ë ¤ë©´ binary logë¥¼ í™œì„±í™”ì‹œì¼œì•¼ í•œë‹¤.

```
$ gcloud config set projectyour-project-id
$ gcloud sql instances patch --enable-bin-logyour-instance-name
```
  

## Connect to Cloud SQL ê´€ë ¨ ì°¸ê³ 

![Untitled](Untitled%202.png)

public IPëŠ” Authorizationì´ í•„ìš”í•œë° ìœ„ì˜ ë°©ë²• ì¤‘ì— ì‚¬ìš©í•´ì•¼ í•œë‹¤.

![Untitled](Untitled%203.png)

private IPëŠ” ë”°ë¡œ authorizationì´ í•„ìš”ì—†ê³  ê°™ì€ VPCë‚´ì´ë©´ ì ‘ì†ì´ ê°€ëŠ¥í•˜ë‚˜ sidecarë¡œ proxyë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ê¶Œì¥ëœë‹¤.

![Untitled](Untitled%204.png)

**Recommended** : applicationì— sidecarë¡œ Proxyë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

GKEì—ì„œ ì‚¬ìš©í•˜ë ¤ë©´ SA( service account )keyë¥¼ secretìœ¼ë¡œ ìƒì„±í•´ì„œ mountí•´ì•¼ í•œë‹¤.

![Untitled](Untitled%205.png)

![Untitled](Untitled%206.png)

[Connecting to Cloud SQL from Kubernetes](https://www.youtube.com/watch?v=CNnzbNQgyzo)

>ğŸ’¡ AWS RDSì™€ëŠ” ì¢€ ë‹¤ë¥¸ ê²ƒ ê°™ë‹¤. RDSëŠ” í¼ë¸”ë¦­ ì—‘ì„¸ìŠ¤ë¥¼ í—ˆìš©í•˜ë©´ ì™¸ë¶€ì—ì„œë„ ë°”ë¡œ ì ‘ê·¼ì´ ê°€ëŠ¥í•œë° Cloud SQLì€ public IPë¥¼ ì‚¬ìš©í•´ë„ authorizationì´ í•„ìš”í•˜ì—¬ Proxyë‚˜ authorized networkë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

### ì™¸ë¶€ì—ì„œ ì—°ê²°

ì™¸ë¶€ì—ì„œ ì—°ê²°í•˜ë ¤ë©´ `cloud_sql_proxy` ë¥¼ ì„¤ì¹˜í•´ì„œ ì“°ê±°ë‚˜ authorized networkë¥¼ ì„¤ì •í•´ì„œ IPë¥¼ í—ˆìš©í•´ì¤˜ì•¼ í•œë‹¤.

![Untitled](Untitled%207.png)

```bash
$ ./cloud_sql_proxy -credential_file=/${HOME}/admingcpacnt.json -instances=project:asia-northeast3:test-replicate=tcp:3306 &
# ì—°ê²°ì´ ìƒì„±ë¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
2022/03/31 15:33:25 Rlimits for file descriptors set to {Current = 8500, Max = 1048576}                                                           
2022/03/31 15:33:25 using credential file for authentication; email=admingcpacnt@project.iam.gserviceaccount.com
2022/03/31 15:33:26 Listening on 127.0.0.1:3306 for project:asia-northeast3:test-replicate
2022/03/31 15:33:26 Ready for new connections
2022/03/31 15:33:26 Generated RSA key in 182.999362ms
2022/03/31 15:35:00 New connection for "project:asia-northeast3:test-replicate"
2022/03/31 15:35:00 refreshing ephemeral certificate for instance project:asia-northeast3:test-replicate
2022/03/31 15:35:00 Scheduling refresh of ephemeral certificate in 54m59.22683158s
2022/03/31 15:35:00 Instance project:asia-northeast3:test-replicate closed connection
...
```

[About connection options | Cloud SQL for MySQL | Google Cloud](https://cloud.google.com/sql/docs/mysql/connect-external-app)

### [ How the Cloud SQL Auth proxy works ]

The Cloud SQL Auth proxy works by having a local client running in the local environment. Your application communicates with the Cloud SQL Auth proxy with the standard database protocol used by your database.

The Cloud SQL Auth proxy **uses a secure tunnel to communicate** with its companion process running on the server. Each connection established through the Cloud SQL Auth proxy creates one connection to the Cloud SQL instance.

When an application connects to Cloud SQL Auth proxy, it checks whether an existing connection between it and the target Cloud SQL instance is available. **If a connection does not exist, it calls Cloud SQL Admin APIs to obtain an ephemeral SSL certificate and uses it to connect to Cloud SQL**. Ephemeral SSL certificates expire in approximately an hour. Cloud SQL Auth proxy refreshes these certificates before they expire.

While the Cloud SQL Auth proxy can listen on any port, it creates outgoing or egress connections to your Cloud SQL instance only on port 3307. Because Cloud SQL Auth proxy calls APIs through the domain nameÂ `sqladmin.googleapis.com`, which does not have a fixed IP address, all egress TCP connections on port 443 must be allowed. If your client machine has an outbound firewall policy, make sure it allows outgoing connections to port 3307 on your Cloud SQL instance's IP.

![Untitled](Untitled%208.png)

[About the Cloud SQL Auth proxy | Cloud SQL for MySQL | Google Cloud](https://cloud.google.com/sql/docs/mysql/sql-proxy#authentication-options)


    
## Quotas
í• ë‹¹ëŸ‰ ì œë„ê°€ ìˆë‹¤. ë¦¬ì „ë§ˆë‹¤, ë¦¬ì†ŒìŠ¤ë§ˆë‹¤ í• ë‹¹ëŸ‰ì´ ì •í•´ì ¸ ìˆì–´ ê·¸ ì´ìƒì„ ë„˜ì–´ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤. í• ë‹¹ëŸ‰ì´ ë‚¨ì•„ë„ ì–´ë–¤ ë¦¬ì „ì˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì“°ê³ ì í•  ë•Œ ì „ë¶€ ì‚¬ìš© ì¤‘ì´ë¼ë©´ ì“¸ ìˆ˜ê°€ ì—†ë‹¤. 

Data Fusionì—ì„œ íŒŒì´í”„ë¼ì¸ì„ ë°°í¬í•˜ê³  ì‹œì‘í•˜ë‹ˆ provisioningì´ ì‹¤íŒ¨í•˜ì˜€ë‹¤. ë„ˆë¬´ ë§ì€ ë¦¬ì†ŒìŠ¤ë¡œ ì„¤ì •í•´ë²„ë ¤ì„œ ì˜¤ë²„í•˜ê²Œ ëœ ê²ƒ ê°™ë‹¤.

```bash
PROVISION task failed in REQUESTING_CREATE state for program run program_run:default.test-2.-SNAPSHOT.worker.DeltaWorker.f10567d8-b0e7-11ec-a3f1-42bae283f4a8 due to Dataproc operation failure: INVALID_ARGUMENT: Insufficient 'CPUS' quota. Requested 1.0, available 0.0..
```

![Untitled](Untitled%2011.png)
[Resource quotas | Compute Engine Documentation | Google Cloud](https://cloud.google.com/compute/quotas#gcloud)
